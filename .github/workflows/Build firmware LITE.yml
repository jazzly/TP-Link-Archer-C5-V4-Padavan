name: Build firmware LITE

on:
  workflow_dispatch:
  push:
    tags:
      - '*'

jobs:
  build:
    runs-on: ubuntu-latest
    container: registry.gitlab.com/hadzhioglu/padavan-ng
    defaults: { run: { shell: bash } }
    steps:
    - uses: actions/checkout@v4

    - name: Get variables
      run: |
        cp "build LITE.config" build.config
        sed -i 's|\r$||g' variables build.config
        . <(cat variables build.config)
        PADAVAN_THEMES="${PADAVAN_THEMES[*]}"
        for v in "${!PADAVAN_@}" "${!CONFIG_@}"; do
          echo "$v=${!v}" >> $GITHUB_ENV
        done

    - name: Download sources and toolchain
      run: |
        git config --global --add safe.directory '*'
        git clone -b "$PADAVAN_BRANCH" "$PADAVAN_REPO"
        git -C padavan-ng checkout "$PADAVAN_COMMIT"
        wget -qO- "$PADAVAN_TOOLCHAIN_URL" | tar -C padavan-ng --zstd -xf -

    - name: Install themes
      run: |
        if [[ -n $PADAVAN_THEMES ]]; then
          git clone --depth 1 -b "$PADAVAN_THEMES_BRANCH" "$PADAVAN_THEMES_REPO" themes
          cp -r themes/common-theme themes/jquery.js padavan-ng/trunk/user/www/n56u_ribbon_fixed

          for theme in $PADAVAN_THEMES; do
            echo "Installing $theme theme"
            cp -r "themes/$theme-theme" padavan-ng/trunk/user/www/n56u_ribbon_fixed
          done
        fi

    - name: Run custom pre-build script
      run: '[[ -f pre-build.sh ]] && . pre-build.sh || :'

    - name: Build firmware
      run: |
        cp build.config padavan-ng/trunk/.config
        pushd padavan-ng/trunk
        ./clear_tree.sh
        ./build_firmware.sh
        popd

    - name: Run custom post-build script
      run: '[[ -f post-build.sh ]] && . post-build.sh || :'

    - name: Prepare artifacts
      run: |
        FW_FILE_NAME="$(find padavan-ng/trunk/images -type f -regextype posix-extended -iregex ".*\.(trx|bin)$" \
                        -printf "%T@\t%f\n" | sort -V | tail -1 | cut -f2)"
        cp "padavan-ng/trunk/images/$FW_FILE_NAME" .
        
        # Create 128KB empty file and recovery firmware
        dd if=/dev/zero of=128kempty.bin bs=128k count=1
        cat 128kempty.bin "$FW_FILE_NAME" > tp_recovery.bin
        
        # Download TFTP server
        wget -O tftpd64.464.zip https://github.com/danayer/TP-Link-Archer-C5-V4-Padavan/releases/download/release-2025.04.22_01.20.13/tftpd64.464.zip
        
        echo "FW_FILE_NAME=$FW_FILE_NAME" >> $GITHUB_ENV
        echo "BUILD_TIMESTAMP=$(date '+%Y.%m.%d_%H.%M.%S')" >> $GITHUB_ENV

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: padavan-ng_${{ env.CONFIG_VENDOR }}_${{ env.CONFIG_FIRMWARE_PRODUCT_ID }}_${{ env.BUILD_TIMESTAMP }}
        retention-days: 7
        path: |
          ${{ env.FW_FILE_NAME }}
          tp_recovery.bin
          tftpd64.464.zip

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: release-${{ env.BUILD_TIMESTAMP }}
        release_name: Padavan TP-Link Archer C5 V4 LITE (${{ env.BUILD_TIMESTAMP }})
        body: |
          ## ðŸ’ ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÑƒ

          Ð•ÑÐ»Ð¸ Ð²Ð°Ð¼ Ð½Ñ€Ð°Ð²Ð¸Ñ‚ÑÑ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ°, Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÑƒ:

          - [ÐšÑƒÐ¿Ð¸Ñ‚ÑŒ ÐºÐ¾Ñ„Ðµ](https://pay.cloudtips.ru/p/afb55f71)
          - [ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ð½Ð° Boosty](https://boosty.to/danayer)
          
          â„¹ï¸ Ðž Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐµ
          
          Ð”Ð°Ð½Ð½Ð°Ñ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ° ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾ Ñ‡Ð¸ÑÑ‚Ð¾Ð¹ Ð²ÐµÑ€ÑÐ¸ÐµÐ¹, ÑÐ¾Ð·Ð´Ð°Ð½Ð½Ð¾Ð¹ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ð¾ Ð´Ð»Ñ Ð¾Ð±Ñ…Ð¾Ð´Ð° Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð¾Ðº ÑÐ°Ð¹Ñ‚Ð¾Ð² Ð¸ ÐºÐ¾Ð¼Ñ„Ð¾Ñ€Ñ‚Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¸Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚Ð¾Ð¼.
          
          ðŸ“‹ Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ¸
          
          ðŸ”° ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ°:

              ðŸ›¡ï¸ ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð±Ñ€Ð°Ð½Ð´Ð¼Ð°ÑƒÑÑ€
              ðŸ”Œ ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ ÐºÐ°Ð±ÐµÐ»ÑŒ Ð² LAN Ð¿Ð¾Ñ€Ñ‚
              âš™ï¸ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ IP: 192.168.0.66
              ðŸ’¿ Ð Ð°ÑÐ¿Ð°ÐºÐ¾Ð²Ñ‹Ð²Ð°ÐµÐ¼ Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Tftpd64
              ðŸ“ ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ tp_recovery.bin Ð² Ð¿Ð°Ð¿ÐºÑƒ TFTP


          ðŸ“ ÐŸÑ€Ð¾Ñ†ÐµÑÑ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ¸:

              ðŸ”Œ Ð’Ñ‹ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ñ€Ð¾ÑƒÑ‚ÐµÑ€
              âš¡ Ð—Ð°Ð¶Ð¸Ð¼Ð°ÐµÐ¼ Reset + Ð²ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð¿Ð¸Ñ‚Ð°Ð½Ð¸Ðµ
              â²ï¸ Ð–Ð´ÐµÐ¼ 10-15 ÑÐµÐºÑƒÐ½Ð´
              ðŸ”„ ÐžÑ‚Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Reset
              ðŸ“Š Ð¡Ð»ÐµÐ´Ð¸Ð¼ Ð·Ð° Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð¼ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ¸ Ð² Ð¾ÐºÐ½Ðµ Tftpd64
              âœ… Ð–Ð´ÐµÐ¼ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ¸


          âš ï¸ Ð’Ð°Ð¶Ð½Ð¾: ÐŸÐ¾ÑÐ»Ðµ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ¸ Ð²ÐµÑ€Ð½Ð¸Ñ‚Ðµ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ IP


          ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ¸
          ðŸ“¥ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð¹ Ð²ÐµÑ€ÑÐ¸Ð¸:

              ðŸ“± ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÐµÑÑŒ Ðº Ñ€Ð¾ÑƒÑ‚ÐµÑ€Ñƒ Ð¿Ð¾ ÐºÐ°Ð±ÐµÐ»ÑŽ LAN (Ð½Ðµ Ð¿Ð¾ Wi-Fi!)
              ðŸŒ ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ð²ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ http://192.168.1.1
              âš™ï¸ ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð² Ñ€Ð°Ð·Ð´ÐµÐ» ÐÐ´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ -> ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ¸
              ðŸ“¦ Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÑŽÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ¸ Ñ GitHub Releases
              ðŸ“¤ Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐºÐ°Ñ‡Ð°Ð½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» .bin (Ð½Ðµ Ð°Ñ€Ñ…Ð¸Ð²!)
              âœ… ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ "ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ" Ð¸ Ð´Ð¾Ð¶Ð´Ð¸Ñ‚ÐµÑÑŒ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ (3-5 Ð¼Ð¸Ð½ÑƒÑ‚)


          ðŸ’¡ ÐŸÑ€Ð¸Ð¼ÐµÑ‡Ð°Ð½Ð¸Ðµ: ÐŸÐµÑ€Ð²Ð°Ñ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· TFTP Ð½ÑƒÐ¶Ð½Ð° Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ð´Ð¸Ð½ Ñ€Ð°Ð·. Ð’ÑÐµ Ð¿Ð¾ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÑŽÑ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· Ð²ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ.
        draft: false
        prerelease: false

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./${{ env.FW_FILE_NAME }}
        asset_name: ${{ env.FW_FILE_NAME }}
        asset_content_type: application/octet-stream

    - name: Upload Recovery Firmware Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./tp_recovery.bin
        asset_name: tp_recovery.bin
        asset_content_type: application/octet-stream

    - name: Upload TFTP Server Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./tftpd64.464.zip
        asset_name: tftpd64.464.zip
        asset_content_type: application/zip

    - name: Check firmware size
      run: |
        partitions=padavan-ng/trunk/configs/boards/$CONFIG_VENDOR/$CONFIG_FIRMWARE_PRODUCT_ID/partitions.config
        max_fw_size="$(awk '/Firmware/ { getline; getline; sub(",", ""); print strtonum($2); }' "$partitions")"
        fw_size="$(stat -c %s "$FW_FILE_NAME")"

        if ((fw_size > max_fw_size)); then
          fw_size_fmtd="$(numfmt --grouping "$fw_size") bytes"
          max_fw_size_fmtd="$(numfmt --grouping "$max_fw_size") bytes"
          echo "Firmware size ($fw_size_fmtd) exceeds max size ($max_fw_size_fmtd) for your target device"
          exit 1
        fi
